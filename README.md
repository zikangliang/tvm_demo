# TVM Runtime ç®€åŒ–æ¶æ„æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ TVM Runtime çš„ç²¾ç®€åµŒå…¥å¼å®ç°ï¼Œé‡‡ç”¨ **8 æ–‡ä»¶æ¶æ„**ï¼Œåœ¨ä¿æŒæ¸…æ™°èŒè´£åˆ†ç¦»çš„åŒæ—¶ï¼Œæœ€å¤§åŒ–ä»£ç çš„å¯ç§»æ¤æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

å½“å‰å®ç°äº†ä¸€ä¸ª **16 ç®—å­ / 9 å±‚ / 8 å†…å­˜æ§½** çš„å¤æ‚æ¨¡å‹ï¼Œç”¨äºéªŒè¯å†…å­˜å¤ç”¨å’Œ BSP è°ƒåº¦çš„æ­£ç¡®æ€§ã€‚

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… BSP é™æ€åˆ†å±‚è°ƒåº¦
- âœ… æé™å†…å­˜å¤ç”¨ï¼ˆ8 æ§½å„å¤ç”¨ 1-3 æ¬¡ï¼‰
- âœ… ä¿ç•™ lib0/lib1 èŒè´£åˆ†ç¦»
- âœ… Runtime å·¥å…·å•æ–‡ä»¶åŒ–
- âœ… é›¶åŠ¨æ€å†…å­˜åˆ†é…
- âœ… å¹³å°å¯ç§»æ¤ï¼ˆPOSIX / RTOSï¼‰

---

## 2. é¡¹ç›®ç›®å½•ç»“æ„

```
tvm_demo/
â”œâ”€â”€ include/
â”‚   â””â”€â”€ tvmgen_default.h       # TVM ç”Ÿæˆçš„å…¬å…±å¤´æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.c                 # æµ‹è¯•ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ default_lib0.c         # Workspace åˆ†é… + è¿è¡Œå…¥å£
â”‚   â”œâ”€â”€ default_lib1.c         # Runtime åˆå§‹åŒ–é€»è¾‘
â”‚   â”œâ”€â”€ tvmrt.h                # Runtime ç»Ÿä¸€å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ tvmrt.c                # Runtime ç»Ÿä¸€å®ç°
â”‚   â”œâ”€â”€ tvmrt_port_posix.c     # OS é€‚é…å±‚ (POSIX)
â”‚   â”œâ”€â”€ model_data.c           # æ¨¡å‹é™æ€æè¿° (16ç®—å­/9å±‚)
â”‚   â””â”€â”€ ops.c                  # ç®—å­å®ç° (6ç§ç®—å­)
â””â”€â”€ Makefile
```

---

## 3. å„æ–‡ä»¶å†…å®¹æ¦‚è¿°

### 3.1 å…¥å£ä¸ Workspace

| æ–‡ä»¶ | å¤§å° | å†…å®¹ |
|------|------|------|
| `main.c` | ~55 è¡Œ | æµ‹è¯•ç¨‹åºå…¥å£ï¼Œå‡†å¤‡è¾“å…¥è¾“å‡ºå¹¶è°ƒç”¨ `tvmgen_default_run()` |
| `default_lib0.c` | ~67 è¡Œ | é™æ€åˆ†é… workspace (64B) å’Œå¸¸é‡åŒº (68B)ï¼Œæä¾› `tvmgen_default_run()` |
| `default_lib1.c` | ~87 è¡Œ | Runtime åˆå§‹åŒ–ï¼Œç®—å­æ‰§è¡Œè¡¨å¡«å……ï¼Œè°ƒç”¨è°ƒåº¦å¼•æ“ |

### 3.2 Runtime æ ¸å¿ƒ

| æ–‡ä»¶ | å¤§å° | å†…å®¹ |
|------|------|------|
| `tvmrt.h` | ~420 è¡Œ | Runtime å®Œæ•´ APIï¼šç±»å‹å®šä¹‰ã€OS æŠ½è±¡ã€æ—¥å¿—ã€å¼•æ“ã€è¯­ä¹‰è½¬æ¢ |
| `tvmrt.c` | ~389 è¡Œ | Runtime å®Œæ•´å®ç°ï¼šæ—¥å¿—ç³»ç»Ÿã€è¯­ä¹‰è½¬æ¢ã€BSP è°ƒåº¦å¼•æ“ |
| `tvmrt_port_posix.c` | ~200 è¡Œ | POSIX å¹³å°é€‚é…ï¼šmutexã€æ¡ä»¶å˜é‡ã€çº¿ç¨‹ã€barrier |

### 3.3 æ¨¡å‹ç›¸å…³

| æ–‡ä»¶ | å¤§å° | å†…å®¹ |
|------|------|------|
| `model_data.c` | ~429 è¡Œ | é™æ€æè¿°è¡¨ï¼š16ç®—å­æè¿°ã€9å±‚è°ƒåº¦è¡¨ã€12ä¸ªå¼ é‡æ˜ å°„ã€å‚æ•°å¡«å…… |
| `ops.c` | ~130 è¡Œ | 6ç§èåˆç®—å­å®ç° + åŒ…è£…å‡½æ•° |

---

## 4. æ¨¡å‹è¯´æ˜

### 4.1 è®¡ç®—å›¾ (16 ç®—å­ / 9 å±‚)

```
è¾“å…¥: input = 10.0

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 1: 4è·¯åˆ†å‰ (å¹¶è¡Œ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op0:  input + 1  â†’ M0    [fused_add]      ç»“æœ: 11
  Op1:  input + 3  â†’ M1    [fused_add_1]    ç»“æœ: 13
  Op2:  input + 5  â†’ M2    [fused_add_2]    ç»“æœ: 15
  Op3:  input + 1  â†’ M3    [fused_add]      ç»“æœ: 11

  å†…å­˜çŠ¶æ€: [11, 13, 15, 11, -, -, -, -]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 2: ä¸¤ä¸¤åˆå¹¶ (å¹¶è¡Œ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op4:  M0 + M1 â†’ M4    [fused_add_3]    ç»“æœ: 24
  Op5:  M2 + M3 â†’ M5    [fused_add_3]    ç»“æœ: 26

  å†…å­˜çŠ¶æ€: [11, 13, 15, 11, 24, 26, -, -]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 3: å˜æ¢ (å¹¶è¡Œ, å¤ç”¨ M0, M1)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op6:  M4 - 2 â†’ M0 ğŸ”´  [fused_subtract]    ç»“æœ: 22
  Op7:  M5 - 4 â†’ M1 ğŸ”´  [fused_subtract_1]  ç»“æœ: 22

  å†…å­˜çŠ¶æ€: [22, 22, 15, 11, 24, 26, -, -]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 4: åˆå¹¶åˆ° M6
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op8:  M0 + M1 â†’ M6    [fused_add_3]    ç»“æœ: 44

  å†…å­˜çŠ¶æ€: [22, 22, 15, 11, 24, 26, 44, -]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 5: ç´¯åŠ é“¾ (å¹¶è¡Œ, å¤ç”¨ M2, M3)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op9:  M6 + 3 â†’ M2 ğŸ”´  [fused_add_1]    ç»“æœ: 47
  Op10: M6 + 5 â†’ M3 ğŸ”´  [fused_add_2]    ç»“æœ: 49

  å†…å­˜çŠ¶æ€: [22, 22, 47, 49, 24, 26, 44, -]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 6: äº¤å‰åˆå¹¶åˆ° M7
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op11: M2 + M3 â†’ M7    [fused_add_3]    ç»“æœ: 96

  å†…å­˜çŠ¶æ€: [22, 22, 47, 49, 24, 26, 44, 96]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 7: æœ€ç»ˆå˜æ¢ (å¹¶è¡Œ, å¤ç”¨ M4, M5)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op12: M7 - 2 â†’ M4 ğŸ”´  [fused_subtract]    ç»“æœ: 94
  Op13: M6 + 1 â†’ M5 ğŸ”´  [fused_add]         ç»“æœ: 45

  å†…å­˜çŠ¶æ€: [22, 22, 47, 49, 94, 45, 44, 96]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 8: åˆå¹¶ (å¤ç”¨ M0)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op14: M4 + M5 â†’ M0 ğŸ”´  [fused_add_3]    ç»“æœ: 139

  å†…å­˜çŠ¶æ€: [139, 22, 47, 49, 94, 45, 44, 96]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Layer 9: è¾“å‡º
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Op15: M0 + M7 â†’ output  [fused_add_3]   ç»“æœ: 235

  è¾“å‡º: 235.0
```

### 4.2 å†…å­˜å¸ƒå±€

| æ§½ä½ | åç§» | å¤§å° | ç”Ÿå‘½å‘¨æœŸ | å¤ç”¨æ¬¡æ•° |
|------|------|------|----------|---------|
| M0 | ws[0] | 4B | L1å†™â†’L3å¤ç”¨â†’L8å¤ç”¨ | 3æ¬¡ |
| M1 | ws[8] | 4B | L1å†™â†’L3å¤ç”¨ | 2æ¬¡ |
| M2 | ws[16] | 4B | L1å†™â†’L5å¤ç”¨ | 2æ¬¡ |
| M3 | ws[24] | 4B | L1å†™â†’L5å¤ç”¨ | 2æ¬¡ |
| M4 | ws[32] | 4B | L2å†™â†’L7å¤ç”¨ | 2æ¬¡ |
| M5 | ws[40] | 4B | L2å†™â†’L7å¤ç”¨ | 2æ¬¡ |
| M6 | ws[48] | 4B | L4å†™ | 1æ¬¡ |
| M7 | ws[56] | 4B | L6å†™ | 1æ¬¡ |

**Workspace æ€»å¤§å°**: 64 bytes

### 4.3 å†…å­˜ç”Ÿå‘½å‘¨æœŸè¯¦è¡¨

| æ§½ | L1 | L2 | L3 | L4 | L5 | L6 | L7 | L8 | L9 |
|----|----|----|----|----|----|----|----|----|-----|
| M0 | å†™11 | è¯» | ğŸ”´22 | è¯» | - | - | - | ğŸ”´139 | è¯»â†’out |
| M1 | å†™13 | è¯» | ğŸ”´22 | è¯» | - | - | - | - | - |
| M2 | å†™15 | è¯» | - | - | ğŸ”´47 | è¯» | - | - | - |
| M3 | å†™11 | è¯» | - | - | ğŸ”´49 | è¯» | - | - | - |
| M4 | - | å†™24 | è¯» | - | - | - | ğŸ”´94 | è¯» | - |
| M5 | - | å†™26 | è¯» | - | - | - | ğŸ”´45 | è¯» | - |
| M6 | - | - | - | å†™44 | è¯» | - | è¯» | - | - |
| M7 | - | - | - | - | - | å†™96 | è¯» | - | è¯»â†’out |

ğŸ”´ = å†…å­˜å¤ç”¨ç‚¹

### 4.4 å¸¸é‡è¡¨

| åç§» | å€¼ | ä½¿ç”¨ç®—å­ |
|------|-----|----------|
| 0 | 5.0 | `fused_add_2` (+5) |
| 16 | 4.0 | `fused_subtract_1` (-4) |
| 32 | 3.0 | `fused_add_1` (+3) |
| 48 | 2.0 | `fused_subtract` (-2) |
| 64 | 1.0 | `fused_add` (+1) |

**å¸¸é‡ Workspace æ€»å¤§å°**: 68 bytes

---

## 5. å‡½æ•°åˆ—è¡¨

### 5.1 `src/main.c` (æµ‹è¯•å…¥å£)

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `main()` | ç¨‹åºå…¥å£ï¼Œå‡†å¤‡æ•°æ®å¹¶è°ƒç”¨æ¨ç†ï¼ŒéªŒè¯ç»“æœä¸º 235.0 |

### 5.2 `src/default_lib0.c` (Workspace)

| å‡½æ•°/æ•°æ® | è¯´æ˜ |
|----------|------|
| `global_const_workspace` | é™æ€åˆ†é…çš„å¸¸é‡åŒº (68 bytes, 5ä¸ªå¸¸é‡) |
| `global_workspace` | é™æ€åˆ†é…çš„å¯å˜ workspace (64 bytes, 8æ§½) |
| `tvmgen_default_run()` | è¿è¡Œå…¥å£ï¼Œè°ƒç”¨ `__tvm_main__` |

### 5.3 `src/default_lib1.c` (Runtime åˆå§‹åŒ–)

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `init_op_execs()` | åˆå§‹åŒ– 16 ä¸ªç®—å­çš„æ‰§è¡Œè¡¨ |
| `tvmgen_default___tvm_main__()` | TVM ä¸»å…¥å£ï¼Œåˆå§‹åŒ–å¹¶è¿è¡Œè°ƒåº¦å¼•æ“ |

### 5.4 `src/tvmrt.c` (Runtime æ ¸å¿ƒ)

#### æ—¥å¿—ç³»ç»Ÿ
| å‡½æ•° | è¯´æ˜ |
|------|------|
| `tvmrt_log_set_callback()` | è®¾ç½®æ—¥å¿—å›è°ƒ |
| `tvmrt_log_push()` | å‹å…¥æ—¥å¿—è®°å½• |
| `tvmrt_log_pop()` | å¼¹å‡ºæ—¥å¿—è®°å½• |
| `tvmrt_log_clear()` | æ¸…ç©ºæ—¥å¿— |
| `tvmrt_log_count()` | è·å–æ—¥å¿—æ•°é‡ |

#### è¯­ä¹‰è½¬æ¢å±‚
| å‡½æ•° | è¯´æ˜ |
|------|------|
| `tvmrt_semantic_init()` | åˆå§‹åŒ–è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ |
| `tvmrt_semantic_resolve_sid()` | è§£æ Storage ID åˆ°æŒ‡é’ˆ |

#### è°ƒåº¦å¼•æ“
| å‡½æ•° | è¯´æ˜ |
|------|------|
| `tvmrt_engine_init()` | åˆå§‹åŒ–è°ƒåº¦å¼•æ“ï¼ˆåˆ›å»ºçº¿ç¨‹æ± ï¼‰ |
| `tvmrt_engine_shutdown()` | å…³é—­è°ƒåº¦å¼•æ“ |
| `tvmrt_engine_run()` | æ‰§è¡Œ BSP è°ƒåº¦ï¼ˆå¤šçº¿ç¨‹ï¼‰ |
| `tvmrt_engine_run_single()` | å•çº¿ç¨‹æ‰§è¡Œï¼ˆå½“å‰é»˜è®¤ä½¿ç”¨ï¼‰ |
| `load_next_layer()` | è¾…åŠ©å‡½æ•°ï¼šåŠ è½½ä¸‹ä¸€å±‚ä»»åŠ¡ |
| `worker_func()` | Worker çº¿ç¨‹å‡½æ•° |

### 5.5 `src/tvmrt_port_posix.c` (OS é€‚é…)

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `tvmrt_mutex_init/lock/unlock/destroy()` | äº’æ–¥é”æ“ä½œ |
| `tvmrt_cond_init/wait/signal/broadcast/destroy()` | æ¡ä»¶å˜é‡æ“ä½œ |
| `tvmrt_thread_create/join()` | çº¿ç¨‹æ“ä½œ |
| `tvmrt_barrier_init/reset/arrive/sync/destroy()` | å±éšœæ“ä½œ |

### 5.6 `src/model_data.c` (æ¨¡å‹æè¿°)

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `model_get_descriptor()` | è·å–æ¨¡å‹æè¿°ç¬¦ |
| `model_get_schedule()` | è·å–é™æ€è°ƒåº¦è¡¨ (9å±‚) |
| `model_fill_args()` | å¡«å…… 16 ä¸ªç®—å­çš„å‚æ•° |
| `model_get_op_args()` | è·å–æŒ‡å®šç®—å­çš„å‚æ•°æŒ‡é’ˆ |

### 5.7 `src/ops.c` (ç®—å­)

| å‡½æ•° | æ“ä½œ |
|------|------|
| `tvmgen_default_fused_add()` | out = p0 + 1.0 |
| `tvmgen_default_fused_add_1()` | out = p0 + 3.0 |
| `tvmgen_default_fused_add_2()` | out = p0 + 5.0 |
| `tvmgen_default_fused_add_3()` | out = p0 + p1 |
| `tvmgen_default_fused_subtract()` | out = p0 - 2.0 |
| `tvmgen_default_fused_subtract_1()` | out = p0 - 4.0 |
| `wrapped_fused_*()` | åŒ…è£…å‡½æ•°ï¼Œé€‚é…ç»Ÿä¸€ç­¾å |

---

## 6. è¿è¡Œæµç¨‹

### 6.1 è°ƒç”¨é¡ºåº

```
main()
  â”œâ”€ åˆ†é…: input_buffer[1] = 10.0, output_buffer[1]
  â””â”€ è°ƒç”¨: tvmgen_default_run(&inputs, &outputs)

tvmgen_default_run() [default_lib0.c]
  â”œâ”€ ä½¿ç”¨: global_const_workspace (68B), global_workspace (64B)
  â””â”€ è°ƒç”¨: tvmgen_default___tvm_main__(input, output, const_ws, ws)

tvmgen_default___tvm_main__() [default_lib1.c]
  â”œâ”€ è°ƒç”¨: tvmrt_engine_init()
  â”‚
  â”œâ”€ è°ƒç”¨: init_op_execs()
  â”‚   â”œâ”€ model_fill_args()      â† å¡«å…… 16 ä¸ªç®—å­å‚æ•°
  â”‚   â””â”€ model_get_op_args()    â† è·å–å‚æ•°æŒ‡é’ˆ
  â”‚
  â”œâ”€ æ„é€ : tvmrt_context_t ctx (16 ä¸ªç®—å­)
  â””â”€ è°ƒç”¨: tvmrt_engine_run_single(&ctx, schedule)

tvmrt_engine_run_single() [tvmrt.c]
  â””â”€ é€å±‚æ‰§è¡Œ:
       Layer 1 â†’ Layer 2 â†’ ... â†’ Layer 9
       å…± 16 ä¸ªç®—å­
```

### 6.2 BSP è°ƒåº¦å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Layer 1 (é˜Ÿåˆ—: [0, 1, 2, 3])             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  Op 0   â”‚  â”‚  Op 1   â”‚  â”‚  Op 2   â”‚  â”‚  Op 3   â”‚       â”‚
â”‚   â”‚  +1â†’M0  â”‚  â”‚  +3â†’M1  â”‚  â”‚  +5â†’M2  â”‚  â”‚  +1â†’M3  â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    â•â•â• BARRIER â•â•â•                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Layer 2 (é˜Ÿåˆ—: [4, 5])                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚     Op 4      â”‚    â”‚     Op 5      â”‚                   â”‚
â”‚   â”‚ M0+M1â†’M4=24   â”‚    â”‚ M2+M3â†’M5=26   â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    â•â•â• BARRIER â•â•â•                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Layer 3 (é˜Ÿåˆ—: [6, 7])                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚     Op 6      â”‚    â”‚     Op 7      â”‚                   â”‚
â”‚   â”‚ M4-2â†’M0ğŸ”´=22  â”‚    â”‚ M5-4â†’M1ğŸ”´=22  â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ... ç»§ç»­åˆ° Layer 9 ...                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 æ•°æ®æµ

```
input (10.0)
    â”‚
    â”œâ”€â”€â–¶ Op0: +1 â”€â”€â–¶ M0 (11) â”€â”€â”¬â”€â”€â–¶ Op4: +M1 â”€â”€â–¶ M4 (24) â”€â”€â–¶ Op6: -2 â”€â”€â–¶ M0ğŸ”´ (22)
    â”‚                          â”‚                                              â”‚
    â”œâ”€â”€â–¶ Op1: +3 â”€â”€â–¶ M1 (13) â”€â”€â”˜                                              â”‚
    â”‚                                                                         â”‚
    â”œâ”€â”€â–¶ Op2: +5 â”€â”€â–¶ M2 (15) â”€â”€â”¬â”€â”€â–¶ Op5: +M3 â”€â”€â–¶ M5 (26) â”€â”€â–¶ Op7: -4 â”€â”€â–¶ M1ğŸ”´ (22)
    â”‚                          â”‚                                              â”‚
    â””â”€â”€â–¶ Op3: +1 â”€â”€â–¶ M3 (11) â”€â”€â”˜                                              â”‚
                                                                              â”‚
    M0 (22) + M1 (22) â”€â”€â–¶ Op8 â”€â”€â–¶ M6 (44) â”€â”€â”¬â”€â”€â–¶ Op9:  +3 â”€â”€â–¶ M2ğŸ”´ (47)      â”‚
                                             â”‚                                â”‚
                                             â””â”€â”€â–¶ Op10: +5 â”€â”€â–¶ M3ğŸ”´ (49)      â”‚
                                                                              â”‚
    M2 (47) + M3 (49) â”€â”€â–¶ Op11 â”€â”€â–¶ M7 (96) â”€â”€â”¬â”€â”€â–¶ Op12: -2 â”€â”€â–¶ M4ğŸ”´ (94)     â”‚
                                              â”‚                               â”‚
    M6 (44) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â–¶ Op13: +1 â”€â”€â–¶ M5ğŸ”´ (45)     â”‚
                                            â”‚                                 â”‚
    M4 (94) + M5 (45) â”€â”€â–¶ Op14 â”€â”€â–¶ M0ğŸ”´ (139)                                â”‚
                                  â”‚                                          â”‚
    M0 (139) + M7 (96) â”€â”€â–¶ Op15 â”€â”€â–¶ output (235)
```

---

## 7. æ ¸å¿ƒç±»å‹å®šä¹‰

### 7.1 æ•°æ®ç»“æ„ (å®šä¹‰åœ¨ `tvmrt.h`)

| ç»“æ„ä½“ | è¯´æ˜ |
|--------|------|
| `tvmrt_layer_queue_t` | å±‚çº§ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå­˜å‚¨å½“å‰å±‚å¾…æ‰§è¡Œç®—å­ï¼‰ |
| `tvmrt_context_t` | è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ï¼ˆworkspaceã€ç®—å­æ‰§è¡Œè¡¨ï¼‰ |
| `tvmrt_op_exec_t` | å¯æ‰§è¡Œç®—å­æ¡ç›®ï¼ˆå‡½æ•°æŒ‡é’ˆ + å‚æ•°ï¼‰ |
| `tvmrt_schedule_desc_t` | é™æ€è°ƒåº¦è¡¨ï¼ˆ9å±‚æ•°ç»„ï¼‰ |
| `tvmrt_schedule_layer_t` | å•ä¸ªè°ƒåº¦å±‚ï¼ˆç®—å­ ID æ•°ç»„ï¼‰ |
| `tvmrt_op_desc_t` | ç®—å­æè¿°ï¼ˆåç§°ã€åç«¯ã€è¾“å…¥è¾“å‡º SIDï¼‰ |
| `tvmrt_tensor_map_entry_t` | Tensor å†…å­˜æ˜ å°„é¡¹ |

### 7.2 å…¨å±€é™æ€å‚æ•°

#### Workspace (default_lib0.c)

```c
static struct global_const_workspace {
    float fused_constant_4_let[1];  // offset 0:  5.0
    float fused_constant_3_let[1];  // offset 16: 4.0
    float fused_constant_2_let[1];  // offset 32: 3.0
    float fused_constant_1_let[1];  // offset 48: 2.0
    float fused_constant_let[1];    // offset 64: 1.0
} global_const_workspace = {...};   // 68 bytes

static uint8_t global_workspace[64];  // 8ä¸ªå†…å­˜æ§½
```

#### æ¨¡å‹æè¿°å‚æ•° (model_data.c)

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `g_tensor_map[]` | `tvmrt_tensor_map_entry_t[]` | å¼ é‡å†…å­˜æ˜ å°„è¡¨ï¼ˆ12ä¸ª SIDï¼‰ |
| `g_op_descs[]` | `tvmrt_op_desc_t[]` | ç®—å­æè¿°è¡¨ï¼ˆ16ä¸ªèŠ‚ç‚¹ï¼‰ |
| `g_cpu_func_table[]` | `tvmrt_op_func_t[]` | CPU å‡½æ•°æŒ‡é’ˆè¡¨ï¼ˆ6ç§ç®—å­ï¼‰ |
| `g_schedule_layers[]` | `tvmrt_schedule_layer_t[]` | é™æ€è°ƒåº¦è¡¨ï¼ˆ9å±‚ï¼‰ |
| `g_single_args[16]` | `FusedAddArgs[]` | å•è¾“å…¥ç®—å­å‚æ•° |
| `g_dual_args[16]` | `FusedAdd3Args[]` | åŒè¾“å…¥ç®—å­å‚æ•° |

#### å¼•æ“çŠ¶æ€ (tvmrt.c)

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `g_engine` | `engine_state_t` | å…¨å±€å¼•æ“çŠ¶æ€ |
| `g_engine.task_queue` | `tvmrt_layer_queue_t` | å½“å‰å±‚ä»»åŠ¡é˜Ÿåˆ— |
| `g_engine.workers[4]` | `tvmrt_thread_t[]` | Worker çº¿ç¨‹æ•°ç»„ |
| `g_engine.layer_barrier` | `tvmrt_barrier_t` | å±‚é—´åŒæ­¥å±éšœ |

---

## 8. ç¼–è¯‘ä¸è¿è¡Œ

### 8.1 å¿«é€Ÿå¼€å§‹

```bash
# ç¼–è¯‘
make all

# è¿è¡Œ
make run

# æ¸…ç†
make clean
```

### 8.2 é¢„æœŸè¾“å‡º

```
========================================
  TVM Runtime: 16ç®—å­ / 9å±‚ / 8å†…å­˜æ§½
========================================
è¾“å…¥å€¼: 10.0
é¢„æœŸè¾“å‡º: 235.0

æ‰§è¡Œä¸­...

--- ç»“æœ ---
æ‰§è¡ŒçŠ¶æ€: æˆåŠŸ
å®é™…è¾“å‡º: 235.0

âœ… æµ‹è¯•é€šè¿‡! ç»“æœæ­£ç¡®
========================================
```

### 8.3 ç¼–è¯‘é€‰é¡¹

```makefile
# Makefile é…ç½®
CC = clang
CFLAGS = -Isrc -Iinclude -Wno-everything -g -O2
```

```c
// tvmrt.h ä¸­é…ç½®
#define TVMRT_NUM_WORKERS 4      // Worker çº¿ç¨‹æ•° (0=å•çº¿ç¨‹)
#define TVMRT_LOG_ENABLE 1       // å¯ç”¨æ—¥å¿—
#define TVMRT_MAX_OPS 64         // æœ€å¤§ç®—å­æ•°
#define TVMRT_MAX_LAYERS 32      // æœ€å¤§å±‚æ•°
```

---

## 9. æ¶æ„ä¼˜åŠ¿

### 9.1 èŒè´£æ¸…æ™°

| ç»„ä»¶ | èŒè´£ | æ–‡ä»¶ |
|------|------|------|
| **å…¥å£å±‚** | æµ‹è¯•ä¸å¤–éƒ¨æ¥å£ | `main.c` |
| **Workspace å±‚** | å†…å­˜åˆ†é…ä¸ç”Ÿå‘½å‘¨æœŸ | `default_lib0.c` |
| **åˆå§‹åŒ–å±‚** | Runtime å¯¹æ¥ä¸åˆå§‹åŒ– | `default_lib1.c` |
| **Runtime å±‚** | è°ƒåº¦å¼•æ“ä¸å·¥å…·å‡½æ•° | `tvmrt.h/c` |
| **OS é€‚é…å±‚** | å¹³å°æŠ½è±¡ | `tvmrt_port_posix.c` |
| **æ¨¡å‹å±‚** | ç¼–è¯‘å™¨ç”Ÿæˆçš„æè¿° | `model_data.c` |
| **ç®—å­å±‚** | ç¼–è¯‘å™¨ç”Ÿæˆçš„å®ç° | `ops.c` |

### 9.2 å¯ç§»æ¤æ€§

- âœ… **å•ä¸€ Runtime API**ï¼šåªéœ€ `#include "tvmrt.h"`
- âœ… **OS é€‚é…åˆ†ç¦»**ï¼šæ›¿æ¢ `tvmrt_port_*.c` å³å¯ç§»æ¤
- âœ… **èŒè´£æ¸…æ™°**ï¼šlib0 è´Ÿè´£å†…å­˜ï¼Œlib1 è´Ÿè´£åˆå§‹åŒ–
- âœ… **é›¶å¤–éƒ¨ä¾èµ–**ï¼šé™¤ pthread å¤–æ— å…¶ä»–ä¾èµ–
- âœ… **é™æ€å†…å­˜**ï¼šé›¶åŠ¨æ€åˆ†é…ï¼Œé€‚åˆåµŒå…¥å¼

### 9.3 æé™å†…å­˜å¤ç”¨

æœ¬æ¨¡å‹éªŒè¯äº†å¤æ‚çš„å†…å­˜å¤ç”¨åœºæ™¯ï¼š
- 8 ä¸ªå†…å­˜æ§½æ”¯æ’‘ 16 ä¸ªç®—å­
- æ¯ä¸ªæ§½è¢«å¤ç”¨ 1-3 æ¬¡
- ä»… 64 bytes workspace

---

## 10. æ‰©å±•ä¸å®šåˆ¶

### 10.1 æ›¿æ¢ OS é€‚é…å±‚

åˆ›å»º `tvmrt_port_rtos.c` å®ç° RTOS çº¿ç¨‹æ¥å£ï¼š

```c
// å®ç°ä»¥ä¸‹å‡½æ•°å³å¯
int tvmrt_mutex_init(tvmrt_mutex_t* m);
int tvmrt_cond_wait(tvmrt_cond_t* c, tvmrt_mutex_t* m);
// ... å…¶ä»–æ¥å£
```

### 10.2 å¯ç”¨å¤šçº¿ç¨‹

ä¿®æ”¹ `default_lib1.c`ï¼š
```c
// å°†
int32_t ret = tvmrt_engine_run_single(&ctx, schedule);
// æ”¹ä¸º
int32_t ret = tvmrt_engine_run(&ctx, schedule);
```

### 10.3 æ›´æ¢æ¨¡å‹

1. ä¿®æ”¹ `model_data.c`ï¼ˆæè¿°è¡¨å’Œè°ƒåº¦è¡¨ï¼‰
2. å¦‚éœ€æ–°ç®—å­ï¼Œä¿®æ”¹ `ops.c`
3. æ›´æ–° `default_lib0.c` ä¸­çš„ workspace å¤§å°

---

## 11. æ–‡ä»¶ä¾èµ–å…³ç³»

```
main.c
  â””â”€â–¶ tvmgen_default.h
  â””â”€â–¶ default_lib0.c
        â””â”€â–¶ tvmgen_default.h
        â””â”€â–¶ default_lib1.c
              â””â”€â–¶ tvmrt.h
              â””â”€â–¶ model_data.c
                    â””â”€â–¶ tvmrt.h
                    â””â”€â–¶ ops.c
                          â””â”€â–¶ tvmrt.h
                          â””â”€â–¶ tvmrt.c
                                â””â”€â–¶ tvmrt.h
                                â””â”€â–¶ tvmrt_port_posix.c
                                      â””â”€â–¶ tvmrt.h
```

---

## 12. å¸¸è§é—®é¢˜

**Q: å¦‚ä½•è°ƒæ•´ Worker çº¿ç¨‹æ•°ï¼Ÿ**  
A: ä¿®æ”¹ `tvmrt.h` ä¸­çš„ `TVMRT_NUM_WORKERS`

**Q: å¦‚ä½•å¯ç”¨æ—¥å¿—ï¼Ÿ**  
A: è®¾ç½® `TVMRT_LOG_ENABLE 1` å¹¶é‡æ–°ç¼–è¯‘

**Q: ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼ï¼Ÿ**  
A: å½“å‰é»˜è®¤ä½¿ç”¨ `tvmrt_engine_run_single` ä»¥ç¡®ä¿ç¨³å®šæ€§

**Q: lib0 å’Œ lib1 çš„åŒºåˆ«ï¼Ÿ**  
A: 
- `lib0`: è´Ÿè´£ **å†…å­˜åˆ†é…**ï¼ˆworkspaceï¼‰å’Œ **å¤–éƒ¨æ¥å£**
- `lib1`: è´Ÿè´£ **Runtime åˆå§‹åŒ–**å’Œ **è°ƒåº¦æ‰§è¡Œ**

**Q: å†…å­˜å¤ç”¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ**  
A: é€šè¿‡åœ¨ `model_data.c` ä¸­å°†ä¸åŒ SID æ˜ å°„åˆ°ç›¸åŒçš„ workspace åç§»

---

## 13. ä»£ç ç»Ÿè®¡

```
æ€»è®¡: ~1800 è¡Œä»£ç ï¼ˆå«æ³¨é‡Šï¼‰

å…¥å£å±‚:
- main.c:           55 è¡Œ
- default_lib0.c:   67 è¡Œ  
- default_lib1.c:   87 è¡Œ

Runtime å±‚:
- tvmrt.h:         420 è¡Œ
- tvmrt.c:         389 è¡Œ
- tvmrt_port_posix.c: 200 è¡Œ

æ¨¡å‹å±‚:
- model_data.c:    429 è¡Œ
- ops.c:           130 è¡Œ
```

---

## 14. è®¸å¯ä¸å¼•ç”¨

æœ¬é¡¹ç›®ä¸º TVM Runtime çš„ç²¾ç®€åµŒå…¥å¼å®ç°ç¤ºä¾‹ã€‚

**å‚è€ƒèµ„æ–™**:
- TVM å®˜æ–¹æ–‡æ¡£: https://tvm.apache.org/
- BSP æ¨¡å‹: Bulk Synchronous Parallel

---

**æœ€åæ›´æ–°**: 2026-01-13  
**æ¨¡å‹è§„æ ¼**: 16 ç®—å­ / 9 å±‚ / 8 å†…å­˜æ§½  
**é¢„æœŸç»“æœ**: input=10.0 â†’ output=235.0
