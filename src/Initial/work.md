# 工作内容记录

---

## 0. 我完成的主要工作

本项目是在 TVM 编译器生成的原始代码基础上，进行的**模块化重构与功能扩展**。以下是我完成的核心工作：

### 🔧 代码重构
1. **模块拆分**：将原始 2 文件单片代码拆分为 8 文件模块化架构
2. **职责分离**：
   - 算子实现 → `ops.c`
   - 模型描述 → `model_data.c`
   - Runtime 核心 → `tvmrt.h` / `tvmrt.c`
   - OS 适配 → `tvmrt_port_posix.c`
3. **代码规范化**：添加注释、结构化分区、统一编码风格

### 🚀 功能扩展
1. **BSP 分层调度引擎**：从串行执行升级为 9 层 Barrier 同步并行调度
2. **多线程支持**：实现 Worker 线程池 + 任务队列
3. **极限内存复用**：设计 16 算子 / 8 内存槽的复杂计算图，每个槽复用 1-3 次
4. **日志系统**：可配置的运行时日志 API
5. **统一算子签名**：包装函数适配 `int32_t func(void*)` 统一接口

### 📦 新增组件
| 文件 | 功能 |
|------|------|
| `main.c` | 测试入口 + 自动化验证 |
| `tvmrt.h` | Runtime 完整 API (420行) |
| `tvmrt.c` | 调度引擎 + 日志实现 (389行) |
| `tvmrt_port_posix.c` | POSIX 线程/互斥锁/屏障 (135行) |
| `model_data.c` | 16算子描述 + 9层调度表 (429行) |
| `ops.c` | 6种算子 + 包装函数 (130行) |

### ✅ 验证成果
- 设计并验证复杂计算图：`input=10.0 → output=235.0`
- 完成编译、运行、结果校验闭环

---

本目录 (`src/Initial/`) 包含 TVM 编译器生成的**原始代码**。`src/` 根目录下的文件是在此基础上进行模块化重构和功能扩展后的版本。

---

## 1. 原始文件概述

| 原始文件 | 行数 | 说明 |
|---------|------|------|
| `default_lib0.c` | 38 行 | Workspace 静态分配 + 入口函数 |
| `default_lib1.c` | 106 行 | 6个算子实现 + 主执行函数 |

**原始模型规模**: 6 个算子，串行执行，36 bytes workspace

---

## 2. 扩展后的文件结构

| 扩展后文件 | 行数 | 对应原始 | 说明 |
|-----------|------|---------|------|
| `default_lib0.c` | 64 行 | ✅ Initial同名 | Workspace 扩展至 64B，支持 8 内存槽 |
| `default_lib1.c` | 88 行 | ✅ Initial同名 | 重构为轻量初始化层，委托给 Runtime |
| `main.c` | 56 行 | 🆕 新增 | 测试程序入口 |
| `tvmrt.h` | 420 行 | 🆕 新增 | Runtime 统一头文件（类型定义 + API） |
| `tvmrt.c` | 389 行 | 🆕 新增 | Runtime 统一实现（日志 + 调度引擎） |
| `tvmrt_port_posix.c` | 135 行 | 🆕 新增 | OS 适配层（POSIX pthread 实现） |
| `model_data.c` | 429 行 | 🆕 新增 | 模型描述符（16算子/9层/静态调度表） |
| `ops.c` | 130 行 | ⬅️ 拆分自 lib1 | 算子实现 + 包装函数 |

**扩展后模型规模**: 16 个算子，9 层 BSP 调度，64 bytes workspace，8 内存槽

---

## 3. 各模块扩展详情

### 3.1 `default_lib0.c` (Workspace 层)

| 对比项 | 原始版本 | 扩展版本 |
|-------|---------|---------|
| **Workspace 大小** | 36 bytes | 64 bytes |
| **内存槽数量** | 3 个 (SID 1-5) | 8 个 (M0-M7) |
| **常量表** | 5 个常量 (68B) | 5 个常量 (68B) ← 保持不变 |
| **代码风格** | 紧凑无注释 | 有结构化注释分区 |
| **section 属性** | `.rodata.tvm` / `.bss.noinit.tvm` | 移除 section 属性 |

**扩展内容**:
- Workspace 从 36B 扩展到 64B 以支持 8 个内存槽的复用场景
- 添加中文注释标明结构分区

---

### 3.2 `default_lib1.c` (初始化层)

| 对比项 | 原始版本 | 扩展版本 |
|-------|---------|---------|
| **职责** | 算子实现 + 串行执行 | 仅负责初始化 + 调用调度引擎 |
| **算子代码** | 内联 6 个算子函数 | 移至 `ops.c` |
| **调度方式** | 硬编码串行顺序 | 委托给 `tvmrt_engine_run_single()` |
| **依赖** | 无外部依赖 | 依赖 `tvmrt.h` + `model_data.c` |

**扩展内容**:
- 引入 `init_op_execs()` 初始化算子执行表
- 引入 `tvmrt_context_t` 运行时上下文
- 支持多线程/单线程调度切换

**原始执行流程**:
```c
// 原始: 硬编码串行执行 6 个算子
if (tvmgen_default_fused_add(input, sid_1, ...) != 0) return -1;
if (tvmgen_default_fused_subtract(sid_1, sid_2, ...) != 0) return -1;
// ... 共 6 步
```

**扩展执行流程**:
```c
// 扩展: 委托给调度引擎
init_op_execs(input, output, workspace, const_workspace);
tvmrt_context_t ctx = { .op_execs = g_op_execs, .op_count = 16 };
tvmrt_engine_run_single(&ctx, schedule);  // 9 层 BSP 调度
```

---

### 3.3 `ops.c` (算子层) - 拆分自 `default_lib1.c`

| 对比项 | 原始版本 (lib1 内) | 扩展版本 |
|-------|-------------------|---------|
| **算子数量** | 6 个 (add/add_1/add_2/add_3/subtract/subtract_1) | 6 个 ← 相同 |
| **文件位置** | 在 `default_lib1.c` 第 38-86 行 | 独立 `ops.c` 文件 |
| **参数结构体** | 无 | 新增 `FusedAddArgs` / `FusedAdd3Args` |
| **包装函数** | 无 | 新增 6 个 `wrapped_fused_*()` 统一签名 |

**扩展内容**:
- 分离算子实现到独立文件，便于替换/扩展
- 添加统一签名包装函数 `int32_t func(void* args)` 以支持 Runtime 调度

---

### 3.4 `main.c` (测试入口) - 新增

原始代码中**没有 main 函数**，需要外部调用 `tvmgen_default_run()`。

**新增内容**:
- 测试入口程序
- 输入准备与结果验证
- 格式化输出 (输入/预期/实际结果)
- 自动化正确性检查

---

### 3.5 `tvmrt.h` / `tvmrt.c` (Runtime 核心) - 新增

原始代码**完全没有 Runtime 抽象层**，算子直接串行调用。

**新增内容**:

#### 类型定义 (`tvmrt.h`)
| 类型 | 说明 |
|------|------|
| `tvmrt_context_t` | 运行时上下文 |
| `tvmrt_op_exec_t` | 可执行算子条目 (函数指针 + 参数) |
| `tvmrt_schedule_desc_t` | 静态调度表 (层级数组) |
| `tvmrt_op_desc_t` | 算子描述符 |
| `tvmrt_tensor_map_entry_t` | Tensor 内存映射 |
| `tvmrt_model_desc_t` | 完整模型描述符 |

#### API 函数 (`tvmrt.c`)
| 函数 | 说明 |
|------|------|
| `tvmrt_engine_init()` | 初始化调度引擎 (可创建线程池) |
| `tvmrt_engine_run()` | 多线程 BSP 调度执行 |
| `tvmrt_engine_run_single()` | 单线程顺序执行 |
| `tvmrt_log_push/pop/clear()` | 日志系统 |
| `tvmrt_semantic_resolve_sid()` | Storage ID 解析 |

#### 日志系统
```c
#define TVMRT_LOG_ENABLE 1
#define TVMRT_LOG_BUFFER_SIZE 128
```

---

### 3.6 `tvmrt_port_posix.c` (OS 适配层) - 新增

原始代码**没有线程/同步支持**。

**新增内容**:

| API | 说明 |
|-----|------|
| `tvmrt_mutex_init/lock/unlock/destroy()` | 互斥锁 |
| `tvmrt_cond_init/wait/signal/broadcast/destroy()` | 条件变量 |
| `tvmrt_thread_create/join()` | 线程管理 |
| `tvmrt_barrier_init/reset/arrive/sync/destroy()` | BSP 屏障同步 |

设计目标: 替换此文件即可移植到 RTOS 平台

---

### 3.7 `model_data.c` (模型描述) - 新增

原始代码的调度逻辑**硬编码在 `__tvm_main__` 中**。

**新增内容**:

#### 静态调度表 (9 层)
```
Layer 1: Op 0-3  (4 并行) → M0-M3
Layer 2: Op 4-5  (2 并行) → M4-M5
Layer 3: Op 6-7  (2 并行) → M0🔴, M1🔴
Layer 4: Op 8    (串行)   → M6
Layer 5: Op 9-10 (2 并行) → M2🔴, M3🔴
Layer 6: Op 11   (串行)   → M7
Layer 7: Op 12-13(2 并行) → M4🔴, M5🔴
Layer 8: Op 14   (串行)   → M0🔴
Layer 9: Op 15   (串行)   → output
```

#### 张量内存映射 (12 SID)
| SID | 偏移 | 用途 |
|-----|------|------|
| 1-4 | 0/8/16/24 | M0-M3 (L1 写, 后续复用) |
| 5-6 | 32/40 | M4-M5 (L2 写, L7 复用) |
| 7-8 | 0/8 | M0/M1 复用 |
| ... | ... | ... |

#### 参数填充
- `model_fill_args()`: 16 个算子的输入输出指针填充
- `model_get_op_args()`: 按 ID 获取算子参数

---

## 4. 核心架构变化

### 4.1 从串行到 BSP 分层调度

```
原始: 硬编码串行
┌────────────────────────────────────┐
│ Op1 → Op2 → Op3 → Op4 → Op5 → Op6  │
└────────────────────────────────────┘

扩展: BSP 分层并行
┌──────────────────────────────────────────────────────┐
│ Layer 1: [Op0, Op1, Op2, Op3] (并行)                 │
├──────────────────────────────────────────────────────┤
│                    ═══ BARRIER ═══                    │
├──────────────────────────────────────────────────────┤
│ Layer 2: [Op4, Op5] (并行)                           │
├──────────────────────────────────────────────────────┤
│                    ═══ BARRIER ═══                    │
├──────────────────────────────────────────────────────┤
│ ...                                                  │
└──────────────────────────────────────────────────────┘
```

### 4.2 从内联到模块化

```
原始文件结构 (2 文件, 144 行):
┌─────────────────────────────────────┐
│ default_lib0.c (38行)               │
│   └── workspace + 入口              │
├─────────────────────────────────────┤
│ default_lib1.c (106行)              │
│   ├── 6 个算子实现                   │
│   └── 硬编码串行执行                 │
└─────────────────────────────────────┘

扩展文件结构 (8 文件, ~1700 行):
┌─────────────────────────────────────┐
│ main.c              ← 测试入口       │
├─────────────────────────────────────┤
│ default_lib0.c      ← Workspace 层   │
│ default_lib1.c      ← 初始化层       │
├─────────────────────────────────────┤
│ tvmrt.h + tvmrt.c   ← Runtime 核心   │
│ tvmrt_port_posix.c  ← OS 适配层      │
├─────────────────────────────────────┤
│ model_data.c        ← 模型描述       │
│ ops.c               ← 算子实现       │
└─────────────────────────────────────┘
```

---

## 5. 代码量变化统计

| 项目 | 原始 | 扩展 | 增量 |
|------|------|------|------|
| **文件数** | 2 | 8 | +6 |
| **总行数** | ~144 | ~1700 | +1556 |
| **算子数** | 6 | 16 | +10 |
| **调度层数** | 1 (串行) | 9 (BSP) | +8 |
| **Workspace** | 36B | 64B | +28B |
| **内存槽** | 3 | 8 | +5 |

---

## 6. 验证测试

原始模型输出未知 (无 main 函数)。

扩展模型验证:
```
输入: 10.0
预期输出: 235.0
计算路径: 10 → (16 算子, 9 层 BSP) → 235
```

运行命令:
```bash
make all && make run
```

预期输出:
```
========================================
  TVM Runtime: 16算子 / 9层 / 8内存槽
========================================
输入值: 10.0
预期输出: 235.0

执行中...

--- 结果 ---
执行状态: 成功
实际输出: 235.0

✅ 测试通过! 结果正确
========================================
```

---

## 7. 总结

本次重构将 TVM 编译器生成的单片化代码转变为模块化、可扩展的嵌入式 Runtime 架构:

| 特性 | 原始 | 扩展 |
|------|------|------|
| **代码组织** | 单片化 | 模块化 (8文件) |
| **执行模式** | 串行 | BSP 分层调度 |
| **并行支持** | 无 | 多线程 Worker 池 |
| **内存复用** | 简单 | 极限复用 (8槽各1-3次) |
| **平台移植** | 困难 | 替换 port 文件即可 |
| **测试验证** | 无 | 自动化测试 |
| **日志系统** | 无 | 完整日志 API |